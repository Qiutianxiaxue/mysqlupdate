{
  "openapi": "3.0.3",
  "info": {
    "title": "MySQL 多租户数据库自动升级系统 API",
    "description": "基于 Node.js 和 TypeScript 的企业级多租户数据库自动升级系统，支持表结构版本化管理、智能检测变更、自动迁移、分区表支持等功能。",
    "version": "1.0.0",
    "contact": {
      "name": "API Support",
      "email": "support@example.com"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "开发环境"
    },
    {
      "url": "https://api.example.com",
      "description": "生产环境"
    }
  ],
  "tags": [
    {
      "name": "系统管理",
      "description": "系统健康检查和基础信息"
    },
    {
      "name": "表结构检测",
      "description": "表结构变更检测相关接口"
    },
    {
      "name": "迁移执行",
      "description": "数据库迁移执行相关接口"
    },
    {
      "name": "表结构定义管理",
      "description": "表结构定义的增删改查操作"
    },
    {
      "name": "企业管理",
      "description": "多租户企业管理接口"
    },
    {
      "name": "连接管理",
      "description": "数据库连接池管理"
    },
    {
      "name": "迁移锁管理",
      "description": "迁移锁的查看、释放和清理操作"
    }
  ],
  "paths": {
    "/": {
      "get": {
        "tags": ["系统管理"],
        "summary": "获取系统信息",
        "description": "获取系统基本信息和可用端点",
        "responses": {
          "200": {
            "description": "系统信息",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "MySQL数据库自动升级服务"
                    },
                    "version": {
                      "type": "string",
                      "example": "1.0.0"
                    },
                    "endpoints": {
                      "type": "object",
                      "properties": {
                        "health": { "type": "string", "example": "/health" },
                        "migration": {
                          "type": "string",
                          "example": "/api/migration"
                        },
                        "schemaDetection": {
                          "type": "string",
                          "example": "/api/schema-detection"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/health": {
      "get": {
        "tags": ["系统管理"],
        "summary": "健康检查",
        "description": "检查系统运行状态",
        "responses": {
          "200": {
            "description": "系统正常",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/schema-detection/table": {
      "post": {
        "tags": ["表结构检测"],
        "summary": "检测单个表结构变化",
        "description": "检测指定表的结构变化",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["tableName"],
                "properties": {
                  "tableName": {
                    "type": "string",
                    "description": "表名",
                    "example": "users"
                  },
                  "databaseType": {
                    "type": "string",
                    "enum": ["main", "log", "order", "static"],
                    "default": "main",
                    "description": "数据库类型"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "检测成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DetectionResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/schema-detection/all": {
      "post": {
        "tags": ["表结构检测"],
        "summary": "检测所有表结构变化",
        "description": "检测基准数据库中所有表的结构变化。现已支持自动表名解析（@符号分割数据库类型）和分表类型检测（基于井号标识规则：#store、#time_day、#time_month、#time_year）",
        "responses": {
          "200": {
            "description": "检测成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AllDetectionResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/schema-detection/detect-and-save": {
      "post": {
        "tags": ["表结构检测"],
        "summary": "检测并保存表结构变化",
        "description": "检测所有表结构变化并自动保存到系统中。现已支持自动表名解析（@符号分割数据库类型）和分表类型检测（基于井号标识规则：#store、#time_day、#time_month、#time_year）",
        "responses": {
          "200": {
            "description": "检测并保存成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DetectionSaveResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/schema-detection/tables": {
      "post": {
        "tags": ["表结构检测"],
        "summary": "获取基准数据库表信息",
        "description": "获取基准数据库中所有表的详细信息",
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BaseTablesResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/schema-detection/table/info": {
      "post": {
        "tags": ["表结构检测"],
        "summary": "获取表详细信息",
        "description": "获取指定表的详细结构信息",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["tableName"],
                "properties": {
                  "tableName": {
                    "type": "string",
                    "description": "表名",
                    "example": "users"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TableInfoResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/schema-detection/preview-partition": {
      "get": {
        "tags": ["表结构检测"],
        "summary": "预览表名解析和分表类型检测结果",
        "description": "预览基准数据库中所有表的表名解析（@符号分割数据库类型）和分表类型检测结果（基于井号标识规则：#store、#time_day、#time_month、#time_year）",
        "responses": {
          "200": {
            "description": "预览成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PreviewPartitionResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/execute": {
      "post": {
        "tags": ["迁移执行"],
        "summary": "执行表迁移",
        "description": "执行指定表的迁移操作",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ExecuteMigrationRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "迁移成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MigrationResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "409": {
            "description": "迁移被锁定",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LockConflictResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/execute-all": {
      "post": {
        "tags": ["迁移执行"],
        "summary": "一键迁移所有表",
        "description": "执行所有活跃表结构定义的迁移",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "enterprise_id": {
                    "type": "integer",
                    "description": "企业ID，可选，不传则为所有企业执行迁移",
                    "example": 1
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "迁移完成",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MigrateAllResponse"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "409": {
            "description": "迁移被锁定",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LockConflictResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/execute-store": {
      "post": {
        "tags": ["迁移执行"],
        "summary": "根据门店ID迁移所有门店分表",
        "description": "为指定企业的指定门店创建/迁移所有门店分区的表",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ExecuteStoreMigrationRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "门店分表迁移完成",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/StoreMigrationResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "409": {
            "description": "迁移被锁定",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LockConflictResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/schemas/create": {
      "post": {
        "tags": ["表结构定义管理"],
        "summary": "创建表结构定义",
        "description": "创建新的表结构定义",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateSchemaRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "创建成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SchemaResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/schemas/list": {
      "post": {
        "tags": ["表结构定义管理"],
        "summary": "获取表结构定义列表",
        "description": "获取所有活跃的表结构定义",
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SchemaListResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/schemas/history": {
      "post": {
        "tags": ["表结构定义管理"],
        "summary": "获取表结构历史版本",
        "description": "获取指定表的所有历史版本",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["table_name", "database_type"],
                "properties": {
                  "table_name": {
                    "type": "string",
                    "description": "表名",
                    "example": "users"
                  },
                  "database_type": {
                    "type": "string",
                    "enum": ["main", "log", "order", "static"],
                    "description": "数据库类型"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SchemaHistoryResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/schemas/detail": {
      "post": {
        "tags": ["表结构定义管理"],
        "summary": "获取表结构定义详情",
        "description": "根据条件获取表结构定义详情",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/GetSchemaRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SchemaDetailResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/schemas/delete": {
      "post": {
        "tags": ["表结构定义管理"],
        "summary": "删除表结构定义",
        "description": "将表结构定义标记为非活跃状态",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/DeleteSchemaRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "删除成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BaseResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/enterprises/list": {
      "post": {
        "tags": ["企业管理"],
        "summary": "获取企业列表",
        "description": "获取所有企业信息",
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EnterpriseListResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/enterprises/create": {
      "post": {
        "tags": ["企业管理"],
        "summary": "创建企业",
        "description": "创建新的企业配置",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateEnterpriseRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "创建成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EnterpriseResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/connections/stats": {
      "post": {
        "tags": ["连接管理"],
        "summary": "获取连接池统计",
        "description": "获取数据库连接池的统计信息",
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ConnectionStatsResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/connections/close": {
      "post": {
        "tags": ["连接管理"],
        "summary": "关闭所有连接",
        "description": "关闭所有数据库连接",
        "responses": {
          "200": {
            "description": "关闭成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BaseResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/locks/list": {
      "post": {
        "tags": ["迁移锁管理"],
        "summary": "获取活跃的迁移锁列表",
        "description": "获取当前所有活跃的迁移锁信息",
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MigrationLocksResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/locks/force-release": {
      "post": {
        "tags": ["迁移锁管理"],
        "summary": "强制释放迁移锁",
        "description": "强制释放指定的迁移锁（用于清理僵尸锁）",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ForceReleaseLockRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "释放成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BaseResponse"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "description": "锁不存在或已被释放",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    },
    "/api/migration/locks/cleanup": {
      "post": {
        "tags": ["迁移锁管理"],
        "summary": "清理过期的迁移锁",
        "description": "清理指定时间之前的过期迁移锁",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CleanupLocksRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "清理成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CleanupLocksResponse"
                }
              }
            }
          },
          "500": {
            "$ref": "#/components/responses/InternalError"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "BaseResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "message": {
            "type": "string",
            "example": "操作成功"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": false
          },
          "message": {
            "type": "string",
            "example": "操作失败"
          },
          "error": {
            "type": "string",
            "example": "详细错误信息"
          }
        }
      },
      "HealthResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "example": "ok"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "example": "2024-01-01T00:00:00.000Z"
          },
          "service": {
            "type": "string",
            "example": "mysql-update"
          }
        }
      },
      "TableColumn": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "列名",
            "example": "user_id"
          },
          "type": {
            "type": "string",
            "description": "数据类型",
            "example": "BIGINT"
          },
          "length": {
            "type": "integer",
            "description": "长度",
            "example": 255
          },
          "primaryKey": {
            "type": "boolean",
            "description": "是否为主键",
            "example": true
          },
          "autoIncrement": {
            "type": "boolean",
            "description": "是否自增",
            "example": true
          },
          "allowNull": {
            "type": "boolean",
            "description": "是否允许为空",
            "example": false
          },
          "defaultValue": {
            "type": "string",
            "description": "默认值",
            "example": "CURRENT_TIMESTAMP"
          },
          "unique": {
            "type": "boolean",
            "description": "是否唯一",
            "example": false
          },
          "comment": {
            "type": "string",
            "description": "注释",
            "example": "用户ID"
          }
        }
      },
      "TableIndex": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "索引名",
            "example": "idx_username"
          },
          "fields": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "索引字段",
            "example": ["username"]
          },
          "unique": {
            "type": "boolean",
            "description": "是否唯一索引",
            "example": true
          }
        }
      },
      "SchemaDefinition": {
        "type": "object",
        "properties": {
          "tableName": {
            "type": "string",
            "description": "表名",
            "example": "users"
          },
          "columns": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TableColumn"
            },
            "description": "列定义"
          },
          "indexes": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TableIndex"
            },
            "description": "索引定义"
          },
          "action": {
            "type": "string",
            "enum": ["DROP"],
            "description": "特殊操作（删除表）"
          }
        }
      },
      "TableSchema": {
        "type": "object",
        "properties": {
          "table_schema_id": {
            "type": "integer",
            "description": "表结构ID",
            "example": 1
          },
          "table_name": {
            "type": "string",
            "description": "表名",
            "example": "users"
          },
          "database_type": {
            "type": "string",
            "enum": ["main", "log", "order", "static"],
            "description": "数据库类型",
            "example": "main"
          },
          "partition_type": {
            "type": "string",
            "enum": ["store", "time", "none"],
            "description": "分区类型",
            "example": "none"
          },
          "schema_version": {
            "type": "string",
            "description": "版本号",
            "example": "1.0.0"
          },
          "schema_definition": {
            "$ref": "#/components/schemas/SchemaDefinition"
          },
          "is_active": {
            "type": "boolean",
            "description": "是否激活",
            "example": true
          },
          "upgrade_notes": {
            "type": "string",
            "description": "升级说明",
            "example": "初始版本创建用户表"
          },
          "time_interval": {
            "type": "string",
            "enum": ["day", "month", "year"],
            "description": "时间分区间隔：day-按天，month-按月，year-按年（时间分表时使用）",
            "example": "month"
          },
          "time_format": {
            "type": "string",
            "description": "时间分区表名格式，如：_YYYY_MM、_YYYY_MM_DD、_YYYY（时间分表时使用）",
            "example": "_YYYY_MM"
          },
          "current_version": {
            "type": "string",
            "description": "升级前的版本号，用于记录版本变化历史",
            "example": "0.9.0"
          },
          "changes_detected": {
            "type": "string",
            "description": "检测到的变化列表，JSON格式存储",
            "example": "[\"新增列user_type\", \"修改列email长度\"]"
          },
          "create_time": {
            "type": "string",
            "format": "date-time",
            "description": "创建时间"
          },
          "update_time": {
            "type": "string",
            "format": "date-time",
            "description": "更新时间"
          }
        }
      },
      "Enterprise": {
        "type": "object",
        "properties": {
          "enterprise_id": {
            "type": "integer",
            "description": "企业ID",
            "example": 1
          },
          "enterprise_key": {
            "type": "string",
            "description": "企业标识",
            "example": "company001"
          },
          "enterprise_name": {
            "type": "string",
            "description": "企业名称",
            "example": "示例公司"
          },
          "database_name": {
            "type": "string",
            "description": "数据库名",
            "example": "company001_db"
          },
          "database_hostname": {
            "type": "string",
            "description": "数据库主机",
            "example": "localhost"
          },
          "database_port": {
            "type": "integer",
            "description": "数据库端口",
            "example": 3306
          },
          "database_username": {
            "type": "string",
            "description": "数据库用户名",
            "example": "company001_user"
          },
          "database_password": {
            "type": "string",
            "description": "数据库密码",
            "example": "secure_password"
          },
          "create_time": {
            "type": "string",
            "format": "date-time",
            "description": "创建时间"
          },
          "update_time": {
            "type": "string",
            "format": "date-time",
            "description": "更新时间"
          }
        }
      },
      "MigrationLock": {
        "type": "object",
        "properties": {
          "migration_lock_id": {
            "type": "integer",
            "description": "迁移锁ID",
            "example": 1
          },
          "lock_key": {
            "type": "string",
            "description": "锁键值",
            "example": "SINGLE_TABLE_users_main_none"
          },
          "lock_type": {
            "type": "string",
            "enum": ["SINGLE_TABLE", "ALL_TABLES"],
            "description": "锁类型",
            "example": "SINGLE_TABLE"
          },
          "table_name": {
            "type": "string",
            "description": "表名",
            "example": "users"
          },
          "database_type": {
            "type": "string",
            "enum": ["main", "log", "order", "static"],
            "description": "数据库类型",
            "example": "main"
          },
          "partition_type": {
            "type": "string",
            "enum": ["store", "time", "none"],
            "description": "分区类型",
            "example": "none"
          },
          "start_time": {
            "type": "string",
            "format": "date-time",
            "description": "锁开始时间",
            "example": "2024-01-01T10:00:00.000Z"
          },
          "lock_holder": {
            "type": "string",
            "description": "锁持有者信息",
            "example": "hostname-1234-abcd1234"
          },
          "operation_info": {
            "type": "string",
            "description": "操作信息",
            "example": "用户表迁移"
          },
          "is_active": {
            "type": "boolean",
            "description": "是否活跃",
            "example": true
          },
          "create_time": {
            "type": "string",
            "format": "date-time",
            "description": "创建时间"
          },
          "update_time": {
            "type": "string",
            "format": "date-time",
            "description": "更新时间"
          }
        }
      },
      "ExecuteMigrationRequest": {
        "type": "object",
        "required": ["table_name", "database_type", "partition_type"],
        "properties": {
          "table_name": {
            "type": "string",
            "description": "表名",
            "example": "users"
          },
          "database_type": {
            "type": "string",
            "enum": ["main", "log", "order", "static"],
            "description": "数据库类型",
            "example": "main"
          },
          "partition_type": {
            "type": "string",
            "enum": ["store", "time", "none"],
            "description": "分区类型",
            "example": "none"
          },
          "schema_version": {
            "type": "string",
            "description": "版本号（可选，默认使用最新版本）",
            "example": "1.2.0"
          },
          "enterprise_id": {
            "type": "integer",
            "description": "企业ID（可选，不传则为所有企业执行迁移）",
            "example": 1
          }
        }
      },
      "CreateSchemaRequest": {
        "type": "object",
        "required": [
          "table_name",
          "database_type",
          "partition_type",
          "schema_version",
          "schema_definition"
        ],
        "properties": {
          "table_name": {
            "type": "string",
            "description": "表名",
            "example": "users"
          },
          "database_type": {
            "type": "string",
            "enum": ["main", "log", "order", "static"],
            "description": "数据库类型",
            "example": "main"
          },
          "partition_type": {
            "type": "string",
            "enum": ["store", "time", "none"],
            "description": "分区类型",
            "example": "none"
          },
          "schema_version": {
            "type": "string",
            "description": "版本号",
            "example": "1.0.0"
          },
          "schema_definition": {
            "$ref": "#/components/schemas/SchemaDefinition"
          },
          "is_active": {
            "type": "boolean",
            "description": "是否激活",
            "default": true
          },
          "upgrade_notes": {
            "type": "string",
            "description": "升级说明",
            "example": "初始版本创建用户表"
          },
          "time_interval": {
            "type": "string",
            "enum": ["day", "month", "year"],
            "description": "时间分区间隔：day-按天，month-按月，year-按年（仅时间分表时需要）",
            "example": "month"
          },
          "time_format": {
            "type": "string",
            "description": "时间分区表名格式，如：_YYYY_MM、_YYYY_MM_DD、_YYYY（仅时间分表时需要）",
            "example": "_YYYY_MM"
          },
          "current_version": {
            "type": "string",
            "description": "升级前的版本号，用于记录版本变化历史（可选）",
            "example": "0.9.0"
          },
          "changes_detected": {
            "type": "string",
            "description": "检测到的变化列表，JSON格式存储（可选）",
            "example": "[\"新增列user_type\", \"修改列email长度\"]"
          }
        }
      },
      "GetSchemaRequest": {
        "type": "object",
        "required": ["table_name", "database_type", "partition_type"],
        "properties": {
          "table_name": {
            "type": "string",
            "description": "表名",
            "example": "users"
          },
          "database_type": {
            "type": "string",
            "enum": ["main", "log", "order", "static"],
            "description": "数据库类型",
            "example": "main"
          },
          "partition_type": {
            "type": "string",
            "enum": ["store", "time", "none"],
            "description": "分区类型",
            "example": "none"
          },
          "schema_version": {
            "type": "string",
            "description": "版本号（可选）",
            "example": "1.0.0"
          }
        }
      },
      "DeleteSchemaRequest": {
        "type": "object",
        "required": ["table_name", "database_type", "partition_type"],
        "properties": {
          "table_name": {
            "type": "string",
            "description": "表名",
            "example": "users"
          },
          "database_type": {
            "type": "string",
            "enum": ["main", "log", "order", "static"],
            "description": "数据库类型",
            "example": "main"
          },
          "partition_type": {
            "type": "string",
            "enum": ["store", "time", "none"],
            "description": "分区类型",
            "example": "none"
          },
          "schema_version": {
            "type": "string",
            "description": "版本号（可选）",
            "example": "1.0.0"
          }
        }
      },
      "CreateEnterpriseRequest": {
        "type": "object",
        "required": [
          "enterprise_key",
          "enterprise_name",
          "database_name",
          "database_hostname",
          "database_username",
          "database_password"
        ],
        "properties": {
          "enterprise_key": {
            "type": "string",
            "description": "企业标识",
            "example": "company001"
          },
          "enterprise_name": {
            "type": "string",
            "description": "企业名称",
            "example": "示例公司"
          },
          "database_name": {
            "type": "string",
            "description": "数据库名",
            "example": "company001_db"
          },
          "database_hostname": {
            "type": "string",
            "description": "数据库主机",
            "example": "localhost"
          },
          "database_port": {
            "type": "integer",
            "description": "数据库端口",
            "default": 3306,
            "example": 3306
          },
          "database_username": {
            "type": "string",
            "description": "数据库用户名",
            "example": "company001_user"
          },
          "database_password": {
            "type": "string",
            "description": "数据库密码",
            "example": "secure_password"
          }
        }
      },
      "ExecuteStoreMigrationRequest": {
        "type": "object",
        "required": ["store_id", "enterprise_id"],
        "properties": {
          "store_id": {
            "type": "string",
            "description": "门店ID，用于生成分表名称",
            "example": "1001"
          },
          "enterprise_id": {
            "type": "integer",
            "description": "企业ID，指定门店所属的企业",
            "example": 1
          }
        }
      },
      "ForceReleaseLockRequest": {
        "type": "object",
        "required": ["lock_key"],
        "properties": {
          "lock_key": {
            "type": "string",
            "description": "要释放的锁键值",
            "example": "SINGLE_TABLE_users_main_none"
          }
        }
      },
      "CleanupLocksRequest": {
        "type": "object",
        "properties": {
          "hours_old": {
            "type": "integer",
            "description": "清理多少小时前的锁，默认24小时",
            "default": 24,
            "example": 24
          }
        }
      },
      "DetectionResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "object",
                "description": "检测结果，如果没有变化则为null"
              }
            }
          }
        ]
      },
      "AllDetectionResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "type": "object"
                },
                "description": "所有变化的表"
              },
              "new_tables": {
                "type": "array",
                "items": {
                  "type": "object"
                },
                "description": "新增的表"
              },
              "deleted_tables": {
                "type": "array",
                "items": {
                  "type": "object"
                },
                "description": "删除的表"
              },
              "summary": {
                "type": "object",
                "properties": {
                  "total_tables": { "type": "integer" },
                  "new_tables": { "type": "integer" },
                  "changed_tables": { "type": "integer" },
                  "deleted_tables": { "type": "integer" },
                  "unchanged_tables": { "type": "integer" }
                }
              }
            }
          }
        ]
      },
      "DetectionSaveResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/AllDetectionResponse" },
          {
            "type": "object",
            "properties": {
              "summary": {
                "type": "object",
                "properties": {
                  "saved": { "type": "boolean" }
                }
              }
            }
          }
        ]
      },
      "BaseTablesResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "tables": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "TABLE_NAME": { "type": "string" },
                        "ENGINE": { "type": "string" },
                        "TABLE_COLLATION": { "type": "string" },
                        "TABLE_ROWS": { "type": "integer" },
                        "DATA_LENGTH": { "type": "integer" },
                        "INDEX_LENGTH": { "type": "integer" },
                        "AUTO_INCREMENT": { "type": "integer" }
                      }
                    }
                  },
                  "summary": {
                    "type": "object",
                    "properties": {
                      "total_tables": { "type": "integer" },
                      "engines": { "type": "object" },
                      "collations": { "type": "object" }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "TableInfoResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "table_name": { "type": "string" },
                  "columns": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "COLUMN_NAME": { "type": "string" },
                        "DATA_TYPE": { "type": "string" },
                        "CHARACTER_MAXIMUM_LENGTH": { "type": "integer" },
                        "IS_NULLABLE": { "type": "string" },
                        "COLUMN_DEFAULT": { "type": "string" },
                        "COLUMN_KEY": { "type": "string" },
                        "EXTRA": { "type": "string" },
                        "COLUMN_COMMENT": { "type": "string" }
                      }
                    }
                  },
                  "indexes": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "INDEX_NAME": { "type": "string" },
                        "COLUMN_NAME": { "type": "string" },
                        "NON_UNIQUE": { "type": "integer" },
                        "SEQ_IN_INDEX": { "type": "integer" }
                      }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "MigrationResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "table_name": { "type": "string" },
                  "database_type": { "type": "string" },
                  "partition_type": { "type": "string" },
                  "schema_version": { "type": "string" },
                  "enterprises_processed": { "type": "integer" },
                  "operations_performed": {
                    "type": "array",
                    "items": { "type": "string" }
                  }
                }
              }
            }
          }
        ]
      },
      "MigrateAllResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "summary": {
                    "type": "object",
                    "properties": {
                      "total_tables": { "type": "integer" },
                      "successful_migrations": { "type": "integer" },
                      "failed_migrations": { "type": "integer" },
                      "total_enterprises": { "type": "integer" }
                    }
                  },
                  "results": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "table_name": { "type": "string" },
                        "database_type": { "type": "string" },
                        "success": { "type": "boolean" },
                        "enterprises_processed": { "type": "integer" },
                        "error": { "type": "string" }
                      }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "SchemaResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "$ref": "#/components/schemas/TableSchema"
              }
            }
          }
        ]
      },
      "SchemaListResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/TableSchema"
                }
              }
            }
          }
        ]
      },
      "SchemaHistoryResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/TableSchema"
                }
              }
            }
          }
        ]
      },
      "SchemaDetailResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "$ref": "#/components/schemas/TableSchema"
              }
            }
          }
        ]
      },
      "EnterpriseResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "$ref": "#/components/schemas/Enterprise"
              }
            }
          }
        ]
      },
      "EnterpriseListResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/Enterprise"
                }
              }
            }
          }
        ]
      },
      "ConnectionStatsResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "total_connections": { "type": "integer" },
                  "active_connections": { "type": "integer" },
                  "idle_connections": { "type": "integer" },
                  "enterprises": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "enterprise_key": { "type": "string" },
                        "connection_status": { "type": "string" },
                        "last_used": { "type": "string" }
                      }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "StoreMigrationResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "total_schemas": {
                    "type": "integer",
                    "description": "总的表结构定义数量",
                    "example": 3
                  },
                  "tables_migrated": {
                    "type": "integer",
                    "description": "成功迁移的表数量",
                    "example": 3
                  },
                  "migration_results": {
                    "type": "array",
                    "description": "详细的迁移结果",
                    "items": {
                      "type": "object",
                      "properties": {
                        "table_name": {
                          "type": "string",
                          "example": "user_behavior"
                        },
                        "database_type": {
                          "type": "string",
                          "example": "main"
                        },
                        "partition_type": {
                          "type": "string",
                          "example": "store"
                        },
                        "schema_version": {
                          "type": "string",
                          "example": "1.0.0"
                        },
                        "success": { "type": "boolean", "example": true },
                        "message": {
                          "type": "string",
                          "example": "门店分表迁移成功到版本 1.0.0"
                        },
                        "actual_table_name": {
                          "type": "string",
                          "example": "user_behavior1001"
                        },
                        "error": {
                          "type": "string",
                          "description": "错误信息（失败时）"
                        },
                        "upgrade_notes": {
                          "type": "string",
                          "description": "升级说明"
                        }
                      }
                    }
                  },
                  "store_id": {
                    "type": "string",
                    "description": "门店ID",
                    "example": "1001"
                  },
                  "enterprise_id": {
                    "type": "integer",
                    "description": "企业ID",
                    "example": 1
                  },
                  "enterprise_name": {
                    "type": "string",
                    "description": "企业名称",
                    "example": "测试企业"
                  },
                  "migration_scope": {
                    "type": "string",
                    "description": "迁移范围",
                    "example": "企业 测试企业"
                  }
                }
              },
              "summary": {
                "type": "object",
                "properties": {
                  "migration_success": { "type": "integer", "example": 3 },
                  "migration_failure": { "type": "integer", "example": 0 },
                  "by_database_type": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "object",
                      "properties": {
                        "total": { "type": "integer" },
                        "success": { "type": "integer" },
                        "failure": { "type": "integer" }
                      }
                    },
                    "example": {
                      "main": { "total": 2, "success": 2, "failure": 0 },
                      "log": { "total": 1, "success": 1, "failure": 0 }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "MigrationLocksResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/MigrationLock"
                }
              }
            }
          }
        ]
      },
      "CleanupLocksResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "cleaned_count": {
                    "type": "integer",
                    "description": "清理的锁数量",
                    "example": 5
                  }
                }
              }
            }
          }
        ]
      },
      "LockConflictResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": false
          },
          "message": {
            "type": "string",
            "example": "迁移被锁定，无法执行"
          },
          "conflict_lock": {
            "type": "object",
            "properties": {
              "lock_key": {
                "type": "string",
                "example": "SINGLE_TABLE_users_main_none"
              },
              "table_name": {
                "type": "string",
                "example": "users"
              },
              "partition_type": {
                "type": "string",
                "example": "none"
              },
              "lock_type": {
                "type": "string",
                "example": "SINGLE_TABLE"
              },
              "start_time": {
                "type": "string",
                "format": "date-time",
                "example": "2024-01-01T10:00:00.000Z"
              },
              "lock_holder": {
                "type": "string",
                "example": "hostname-1234-abcd1234"
              }
            }
          }
        }
      },
      "PreviewPartitionResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "type": "object",
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "detection_results": {
                    "type": "array",
                    "description": "表名解析和分表类型检测结果",
                    "items": {
                      "type": "object",
                      "properties": {
                        "original_table_name": {
                          "type": "string",
                          "description": "原始表名（包含@符号的完整表名）",
                          "example": "users#store@log"
                        },
                        "parsed_table_name": {
                          "type": "string",
                          "description": "解析后的表名（去除@符号后的部分）",
                          "example": "users#store"
                        },
                        "clean_table_name": {
                          "type": "string",
                          "description": "清理后的表名（去除分表规则标识后的最终表名）",
                          "example": "users"
                        },
                        "database_type": {
                          "type": "string",
                          "enum": ["main", "log", "order", "static"],
                          "description": "解析出的数据库类型",
                          "example": "log"
                        },
                        "partition_type": {
                          "type": "string",
                          "enum": ["store", "time", "none"],
                          "description": "检测出的分表类型",
                          "example": "store"
                        },
                        "time_interval": {
                          "type": "string",
                          "enum": ["day", "month", "year"],
                          "description": "时间分表间隔（仅时间分表时有值）",
                          "example": "month"
                        },
                        "time_format": {
                          "type": "string",
                          "description": "时间分表格式（仅时间分表时有值）",
                          "example": "_YYYY_MM"
                        },
                        "has_parsing": {
                          "type": "boolean",
                          "description": "是否进行了表名解析（是否包含@符号）",
                          "example": true
                        },
                        "has_partition": {
                          "type": "boolean",
                          "description": "是否检测到分表规则",
                          "example": true
                        },
                        "has_rule_removal": {
                          "type": "boolean",
                          "description": "是否进行了分表规则标识清理",
                          "example": true
                        }
                      }
                    }
                  },
                  "summary": {
                    "type": "object",
                    "description": "统计信息",
                    "properties": {
                      "total_tables": {
                        "type": "integer",
                        "description": "总表数量",
                        "example": 25
                      },
                      "by_database_type": {
                        "type": "object",
                        "description": "按数据库类型分组统计",
                        "properties": {
                          "main": {
                            "type": "integer",
                            "description": "主数据库表数量",
                            "example": 15
                          },
                          "log": {
                            "type": "integer",
                            "description": "日志数据库表数量",
                            "example": 5
                          },
                          "order": {
                            "type": "integer",
                            "description": "订单数据库表数量",
                            "example": 3
                          },
                          "static": {
                            "type": "integer",
                            "description": "静态数据库表数量",
                            "example": 2
                          }
                        }
                      },
                      "by_partition_type": {
                        "type": "object",
                        "description": "按分表类型分组统计",
                        "properties": {
                          "none": {
                            "type": "integer",
                            "description": "无分表的表数量",
                            "example": 18
                          },
                          "store": {
                            "type": "integer",
                            "description": "门店分表的表数量",
                            "example": 4
                          },
                          "time": {
                            "type": "integer",
                            "description": "时间分表的表数量",
                            "example": 3
                          }
                        }
                      },
                      "tables_with_parsing": {
                        "type": "integer",
                        "description": "需要表名解析的表数量（包含@符号）",
                        "example": 10
                      },
                      "tables_with_partition": {
                        "type": "integer",
                        "description": "检测到分表规则的表数量",
                        "example": 7
                      }
                    }
                  }
                }
              }
            }
          }
        ]
      }
    },
    "responses": {
      "BadRequest": {
        "description": "请求参数错误",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/ErrorResponse"
            }
          }
        }
      },
      "NotFound": {
        "description": "资源不存在",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/ErrorResponse"
            }
          }
        }
      },
      "InternalError": {
        "description": "服务器内部错误",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/ErrorResponse"
            }
          }
        }
      }
    }
  }
}
